name: Build Image

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo df -h
        
    - name: Update apt
      run: |
        sudo apt-get update
        sudo apt-get clean
      
    - name: Install Dependencies
      run: |
        sudo apt-get install -y \
          coreutils \
          p7zip-full \
          qemu-user-static \
          python3-git \
          wget \
          fake-hwclock \
          initramfs-tools \
          systemd-container
        
    - name: Setup build environment
      run: |
        sudo mkdir -p /sys
        sudo mount -t sysfs sysfs /sys || true
        
    - name: Checkout CustomPiOS
      uses: actions/checkout@v4
      with:
        repository: 'guysoft/CustomPiOS'
        path: CustomPiOS
        
    - name: Checkout Project Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        path: repository
        submodules: true
        
    - name: Cache Raspbian Image
      id: cache-raspbian
      uses: actions/cache@v3
      with:
        path: repository/src/image/raspios_lite_armhf_latest
        key: ${{ runner.os }}-raspbian-${{ hashFiles('repository/src/image/raspios_lite_armhf_latest') }}
        
    - name: Download Raspbian Image
      if: steps.cache-raspbian.outputs.cache-hit != 'true'
      run: |
        cd repository/src/image
        wget -q -c --trust-server-names 'https://downloads.raspberrypi.org/raspios_lite_armhf_latest'
        
    - name: Update CustomPiOS Paths
      run: |
        cd repository/src
        ../../CustomPiOS/src/update-custompios-paths
        
    - name: Prepare chroot environment
      run: |
        sudo mkdir -p repository/src/workspace/mount/{proc,sys,dev/pts,boot,var/cache/apt/archives/partial}
        sudo chmod 755 repository/src/workspace/mount/var/cache/apt/archives/partial
        sudo mount -t proc proc repository/src/workspace/mount/proc || true
        sudo mount -t sysfs sysfs repository/src/workspace/mount/sys || true
        sudo mount -t devpts devpts repository/src/workspace/mount/dev/pts || true
        
    - name: Configure initramfs-tools
      run: |
        sudo mkdir -p repository/src/workspace/mount/etc/initramfs-tools/conf.d/
        echo 'MODULES=dep' | sudo tee repository/src/workspace/mount/etc/initramfs-tools/conf.d/modules > /dev/null
        echo 'COMPRESS=xz' | sudo tee -a repository/src/workspace/mount/etc/initramfs-tools/conf.d/modules > /dev/null
        
    - name: Build Image
      run: |
        sudo modprobe loop
        cd repository/src
        sudo systemd-nspawn -D workspace/mount /bin/bash -c "mount -t sysfs sysfs /sys || true"
        sudo bash -x ./build_dist
      
    - name: Find and Copy Image
      run: |
        sudo mkdir -p output
        sudo chmod 777 output
        sudo find repository/src/workspace -name "*-raspios-*-lite.img" -exec sudo cp {} output/build.img \; || true
        sudo chown $USER:$USER output/build.img || true
        
    - name: Compress Output
      if: success()
      run: |
        cd output
        if [ -f build.img ]; then
          gzip -9 build.img
        else
          echo "No image file found to compress"
          exit 1
        fi
        
    - name: Upload Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: build.img.gz
        path: output/build.img.gz
        
    - name: Cleanup
      if: always()
      run: |
        sudo umount -f /sys || true
        sudo umount -f repository/src/workspace/mount/proc || true
        sudo umount -f repository/src/workspace/mount/sys || true
        sudo umount -f repository/src/workspace/mount/dev/pts || true
        sudo rm -rf output
        sudo rm -rf repository/src/workspace
        sudo df -h
